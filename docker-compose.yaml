version: '3.8'

services:
   db:
      image: postgres:latest
      healthcheck:
         test: ["CMD", "pg_isready", "-U", "postgres"]
         interval: 5s
         timeout: 5s
         retries: 5
      environment:
         - POSTGRES_DB=cicd-project
      env_file:
         - compose.env
      volumes:
         - pgdata:/var/lib/postgresql/data

   app:
      build:
         context: ./cicd-app
         dockerfile: Dockerfile
      image: cicd-project-back:0.1.0
      ports:
         - '3000:2022'
      depends_on:
         db:
            condition: service_healthy
      env_file:
         - compose.env

   prometheus:
      image: prom/prometheus
      ports:
         - '9090:9090'
      volumes:
         - ./prometheus.yml:/etc/prometheus/prometheus.yml

volumes:
   pgdata:
